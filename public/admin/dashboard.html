<!DOCTYPE html>
<html>
<head>
  <title>Dashboard Admin - Warung Nyam Nyam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f6f6f6;
    }

    header {
      background: #e63946;
      color: white;
      padding: 16px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      padding: 16px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .search-box {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      width: 200px;
      font-size: 14px;
    }

    .btn {
      background: #e63946;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
      font-size: 14px;
    }

    .btn.gray {
      background: #555;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,0.05);
    }

    th, td {
      padding: 12px;
      text-align: left;
      font-size: 14px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }

    th {
      background: #fafafa;
    }

    tr:hover {
      background: #f9f9f9;
    }

    .thumb {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      object-fit: cover;
      background: #eee;
      display: block;
    }

    .thumb-wrap {
      width: 50px;
      height: 50px;
      background: #eee;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #888;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }

    .badge.active { background: #e6f7ec; color: #1f7a3f; }
    .badge.inactive { background: #fdeaea; color: #a11a1a; }
    .badge.best { background: #fff4d6; color: #9a6b00; }

    .actions { white-space: nowrap; }
    .actions a {
      margin-right: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }

    .actions .edit { color: #e63946; }
    .actions .delete { color: #555; }

    .status {
      font-size: 14px;
      margin-top: 10px;
      color: #666;
    }
  </style>
</head>
<body>

<header>üõ† Dashboard Admin</header>

<div class="container">

  <div class="topbar">
    <div style="display:flex; align-items:center; gap:10px;">
      <strong>Daftar Menu</strong>
      <input type="text" id="searchInput" class="search-box" placeholder="üîç Cari menu...">
    </div>

    <div>
      <a href="/admin/add.html" class="btn">‚ûï Tambah Menu</a>
      <button class="btn gray" id="logoutBtn">Logout</button>
    </div>
  </div>

  <div style="overflow-x:auto;">
    <table>
      <thead>
        <tr>
          <th>Gambar</th>
          <th>Nama</th>
          <th>Harga</th>
          <th>Kategori</th>
          <th>Status</th>
          <th>Best Seller</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="7">Memuat data...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="status" id="status"></div>
</div>

<script>
// 1. Cek Login di Awal
const token = localStorage.getItem('token')
if (!token) {
    window.location.replace('/admin/login.html') // Pakai replace biar gak bisa back
}

const tbody = document.getElementById('tbody')
const statusEl = document.getElementById('status')
const searchInput = document.getElementById('searchInput')
const logoutBtn = document.getElementById('logoutBtn') // Ambil tombol logout

let allMenus = [] 

function rupiah(n) {
  return 'Rp ' + Number(n || 0).toLocaleString('id-ID')
}

// Render Data
function renderMenus(data) {
  if (!Array.isArray(data) || !data.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px;">Menu tidak ditemukan.</td></tr>`
    return
  }

  tbody.innerHTML = data.map(m => `
    <tr>
      <td>
        ${
          m.image_url
            ? `<img src="${m.image_url}" class="thumb" onerror="this.onerror=null;this.src='/images/no-image.png'">`
            : `<div class="thumb-wrap">No Img</div>`
        }
      </td>
      <td>${m.name || '-'}</td>
      <td>${rupiah(m.price)}</td>
      <td>${m.category || '-'}</td>
      <td>
        ${m.is_active 
          ? `<span class="badge active">Aktif</span>` 
          : `<span class="badge inactive">Nonaktif</span>`}
      </td>
      <td>
        ${m.is_best_seller ? `<span class="badge best">‚≠ê Best</span>` : '-'}
      </td>
      <td class="actions">
        <a href="/admin/edit.html?id=${m.id}" class="edit">Edit</a>
        <a class="delete" onclick="hapus('${m.id}')">Hapus</a>
      </td>
    </tr>
  `).join('')
}

// Load Data dari API
async function loadMenus() {
  try {
    const res = await fetch('/api/admin/menus', {
      headers: { Authorization: `Bearer ${token}` }
    })

    if (res.status === 401) {
        handleLogout() // Token expired, auto logout
        return
    }

    if (!res.ok) throw new Error('Gagal ambil data')

    const data = await res.json()
    allMenus = data 
    renderMenus(allMenus) 

  } catch (err) {
    console.error(err)
    tbody.innerHTML = `<tr><td colspan="7">Gagal memuat data. Cek koneksi server.</td></tr>`
  }
}

// Search Logic
searchInput.addEventListener('input', (e) => {
  const keyword = e.target.value.toLowerCase()
  const filtered = allMenus.filter(item => 
    item.name.toLowerCase().includes(keyword) || 
    (item.category && item.category.toLowerCase().includes(keyword))
  )
  renderMenus(filtered)
})

// Hapus Menu
async function hapus(id) {
  if (!confirm('Yakin mau hapus menu ini?')) return

  try {
    statusEl.textContent = '‚è≥ Sedang menghapus...'
    
    const res = await fetch(`/api/admin/menus/${id}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` }
    })

    const data = await res.json()
    if (!res.ok) throw new Error(data.error || 'Gagal hapus')

    statusEl.textContent = '‚úÖ Menu berhasil dihapus'
    loadMenus() 
  } catch (err) {
    statusEl.textContent = '‚ùå ' + err.message
  }
}

// FIX: Fungsi Logout yang Lebih Aman & Rapi
function handleLogout() {
    localStorage.clear() // Hapus semua session
    window.location.replace('/admin/login.html') // Redirect dan hapus history back
}

// Event Listener untuk tombol Logout
logoutBtn.addEventListener('click', () => {
    if (confirm('Apakah Anda yakin ingin keluar?')) {
        handleLogout()
    }
})

// Jalankan Load
loadMenus()
</script>

</body>
</html>