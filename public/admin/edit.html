<!DOCTYPE html>
<html>
<head>
  <title>Edit Menu - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/admin/layout.css">

  <style>
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #111;
      color: #fff;
      padding: 12px 20px;
      border-radius: 999px;
      font-size: 14px;
      opacity: 0;
      pointer-events: none;
      transition: 0.3s;
    }

    .toast.show {
      opacity: 1;
      bottom: 30px;
    }

    .loading {
      font-size: 13px;
      color: #777;
      margin-bottom: 10px;
    }

    .loading-text {
      font-size: 13px;
      color: #777;
      margin-top: 6px;
    }
  </style>
</head>
<body>

<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">üçΩ Warung Nyam Nyam</div>
    <nav class="nav">
        <a href="/admin/dashboard.html">Dashboard</a>
        <a href="/admin/add.html">Tambah Menu</a>
        <a href="/admin/logs.html">Audit Log</a>
        <a href="#" id="logoutBtn">Logout</a>
        </nav>

  </aside>

  <!-- Main -->
  <div class="main">
    <div class="topbar">Edit Menu</div>

    <div class="content">
      <div class="card">

        <div id="status" class="loading">Memuat data menu...</div>

        <div id="form" style="display:none">

          <div class="group">
            <label>Nama Menu</label>
            <input id="menu_name" placeholder="Contoh: Ayam Geprek Sambal Ijo">
          </div>

          <div class="row">
            <div class="group">
              <label>Harga</label>
              <input id="price" type="number">
            </div>
            <div class="group">
              <label>Kategori</label>
              <input id="category">
            </div>
          </div>

          <div class="group">
            <label>Gambar Menu</label>
            <input type="file" id="image_file" accept="image/*">
            <div id="uploadStatus" class="loading-text"></div>
            <img id="preview" class="preview">
          </div>

          <div class="group">
            <label>
              <input type="checkbox" id="is_active">
              Menu aktif
            </label>
          </div>

          <div class="group">
            <label>
              <input type="checkbox" id="is_best">
              Best Seller ‚≠ê
            </label>
          </div>

          <div class="actions">
            <button class="primary" id="saveBtn">Simpan Perubahan</button>
            <button class="secondary" onclick="location.href='/admin/dashboard.html'">
              Batal & Kembali
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="/admin/layout.js"></script>

<script>
const token = localStorage.getItem('token')
if (!token) location.href = '/admin/login.html'

const logoutBtn = document.getElementById('logoutBtn')
logoutBtn.onclick = () => {
  localStorage.removeItem('token')
  location.href = '/admin/login.html'
}

const id = new URLSearchParams(location.search).get('id')

const statusEl = document.getElementById('status')
const formEl = document.getElementById('form')
const toast = document.getElementById('toast')
const saveBtn = document.getElementById('saveBtn')

const nameInput = document.getElementById('menu_name')
const priceInput = document.getElementById('price')
const categoryInput = document.getElementById('category')
const fileInput = document.getElementById('image_file')
const activeInput = document.getElementById('is_active')
const bestInput = document.getElementById('is_best')
const preview = document.getElementById('preview')
const uploadStatus = document.getElementById('uploadStatus')

let existingImageUrl = ''

function showToast(msg) {
  toast.textContent = msg
  toast.classList.add('show')
  setTimeout(() => toast.classList.remove('show'), 2500)
}

// Preview gambar saat pilih file baru
fileInput.onchange = () => {
  const file = fileInput.files[0]
  if (file) {
    preview.src = URL.createObjectURL(file)
    preview.style.display = 'block'
  }
}

// Upload ke backend (ImgBB)
async function uploadImage(file) {
  // Batasi 8MB di sisi user (biar tidak buang waktu upload)
  const maxSize = 8 * 1024 * 1024

  if (file.size > maxSize) {
    throw new Error('Ukuran gambar terlalu besar. Maksimal 8MB.')
  }

  const formData = new FormData()
  formData.append('image', file)

  uploadStatus.textContent = 'Mengupload gambar...'

  const res = await fetch('/api/upload-image', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${token}`
    },
    body: formData
  })

  const text = await res.text()

  let data
  try {
    data = JSON.parse(text)
  } catch {
    throw new Error(text || 'Upload gagal')
  }

  if (!res.ok) {
    throw new Error(data.error || 'Upload gagal')
  }

  uploadStatus.textContent = 'Upload selesai'
  return data.url
}


// API helper
async function api(url, options = {}) {
  const res = await fetch(url, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`
    }
  })

  if (res.status === 401) {
    showToast('Session habis, login ulang')
    localStorage.removeItem('token')
    setTimeout(() => location.href = '/admin/login.html', 1000)
    throw new Error('Unauthorized')
  }

  if (!res.ok) {
    throw new Error(await res.text())
  }

  return res.json()
}

// Load data menu
async function load() {
  try {
    const menu = await api('/api/admin/menus/' + id)

    nameInput.value = menu.name || ''
    priceInput.value = menu.price || ''
    categoryInput.value = menu.category || ''
    activeInput.checked = !!menu.is_active
    bestInput.checked = !!menu.is_best_seller

    existingImageUrl = menu.image_url || ''

    if (existingImageUrl) {
      preview.src = existingImageUrl
      preview.style.display = 'block'
    }

    statusEl.style.display = 'none'
    formEl.style.display = 'block'

  } catch (err) {
    console.error(err)
    statusEl.innerText = 'Gagal memuat data menu'
  }
}

saveBtn.onclick = async () => {
  if (!nameInput.value.trim()) return showToast('Nama menu wajib diisi')
  if (!categoryInput.value.trim()) return showToast('Kategori wajib diisi')
  if (priceInput.value <= 0) return showToast('Harga tidak valid')

  saveBtn.disabled = true
  saveBtn.innerText = 'Memproses...'

  try {
    let imageUrl = existingImageUrl

    // Jika user pilih gambar baru ‚Üí upload dulu
    if (fileInput.files.length > 0) {
      imageUrl = await uploadImage(fileInput.files[0])
    }

    await api('/api/admin/menus/' + id, {
      method: 'PUT',
      body: JSON.stringify({
        name: nameInput.value.trim(),
        price: Number(priceInput.value),
        category: categoryInput.value.trim(),
        image_url: imageUrl,
        is_active: activeInput.checked,
        is_best_seller: bestInput.checked
      })
    })

    showToast('Perubahan berhasil disimpan')
    setTimeout(() => location.href = '/admin/dashboard.html', 800)

  } catch (err) {
    console.error(err)
    showToast('Gagal upload atau simpan')
  } finally {
    saveBtn.disabled = false
    saveBtn.innerText = 'Simpan Perubahan'
  }
}

load()
</script>

</body>
</html>
