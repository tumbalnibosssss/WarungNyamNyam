<!DOCTYPE html>
<html>
<head>
  <title>Menu - Warung Nyam Nyam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f7f7f7;
    }

    header {
      background: #e63946;
      color: white;
      padding: 16px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .container {
      padding: 16px;
      max-width: 1100px;
      margin: auto;
    }

    .category {
      margin-bottom: 32px;
    }

    .category h2 {
      margin: 8px 0 16px;
      font-size: 20px;
      border-left: 5px solid #e63946;
      padding-left: 10px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
    }

    /* CARD */
    .card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .card img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      background: #eee;
    }

    .card-body {
      padding: 12px;
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    /* Nama menu maksimal 2 baris */
    .name {
      font-weight: 600;
      margin-bottom: 6px;
      line-height: 1.3;
      min-height: 2.6em;

      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .price {
      color: #e63946;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .btn {
      border: none;
      background: #e63946;
      color: white;
      padding: 10px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
    }

    /* Supaya tombol selalu sejajar di bawah */
    .card-body button {
      margin-top: auto;
    }

    /* CART */
    .cart {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #eee;
      padding: 12px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
      font-size: 14px;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .qty-control {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .qty-btn {
      border: none;
      background: #eee;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    .total {
      font-weight: bold;
      margin: 10px 0;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<header>üçΩ Menu Warung Nyam Nyam</header>

<div class="container" id="menu-container"></div>

<div id="cart" class="cart hidden">
  <div id="cart-items"></div>
  <div class="total" id="cart-total"></div>
  <button class="btn" onclick="checkout()">Pesan via WhatsApp</button>
</div>

<script>
const WA_NUMBER = "6281261040365"

let menus = []
let cart = {}

function rupiah(n) {
  return 'Rp ' + Number(n).toLocaleString('id-ID')
}

async function loadMenus() {
  const res = await fetch('/api/menus')
  menus = await res.json()
  renderMenus()
}

function renderMenus() {
  const container = document.getElementById('menu-container')

  const grouped = {}
  menus.forEach(m => {
    const cat = m.category || 'Lainnya'
    if (!grouped[cat]) grouped[cat] = []
    grouped[cat].push(m)
  })

  container.innerHTML = Object.keys(grouped).map(cat => `
    <div class="category">
      <h2>${cat}</h2>
      <div class="grid">
        ${grouped[cat].map(m => `
          <div class="card">
            <img 
              src="${m.image_url || '/images/no-image.png'}"
              onerror="this.src='/images/no-image.png'"
            >
            <div class="card-body">
              <div class="name">${m.name}</div>
              <div class="price">${rupiah(m.price)}</div>
              <button class="btn" onclick="addToCart('${m.id}')">
                Tambah ke Keranjang
              </button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `).join('')
}

function addToCart(id) {
  cart[id] = (cart[id] || 0) + 1
  renderCart()
}

function increase(id) {
  cart[id]++
  renderCart()
}

function decrease(id) {
  cart[id]--
  if (cart[id] <= 0) delete cart[id]
  renderCart()
}

function renderCart() {
  const cartEl = document.getElementById('cart')
  const itemsEl = document.getElementById('cart-items')
  const totalEl = document.getElementById('cart-total')

  const items = Object.entries(cart)
  if (items.length === 0) {
    cartEl.classList.add('hidden')
    return
  }

  cartEl.classList.remove('hidden')

  let total = 0

  itemsEl.innerHTML = items.map(([id, qty]) => {
    const menu = menus.find(m => m.id === id)
    const subtotal = menu.price * qty
    total += subtotal

    return `
      <div class="cart-item">
        <div>
          ${menu.name}<br>
          <small>${rupiah(menu.price)} x ${qty} = ${rupiah(subtotal)}</small>
        </div>

        <div class="qty-control">
          <button class="qty-btn" onclick="decrease('${id}')">‚àí</button>
          <strong>${qty}</strong>
          <button class="qty-btn" onclick="increase('${id}')">+</button>
        </div>
      </div>
    `
  }).join('')

  totalEl.innerText = `Total: ${rupiah(total)}`
}

function checkout() {
  let text = 'Bang aku pesan:%0A'
  let total = 0

  Object.entries(cart).forEach(([id, qty], i) => {
    const m = menus.find(x => x.id === id)
    const subtotal = m.price * qty
    total += subtotal

    text += `${i+1}. ${m.name} = ${qty} x ${rupiah(m.price)} = ${rupiah(subtotal)}%0A`
  })

  text += `%0ATotal: ${rupiah(total)}`

  window.open(`https://wa.me/${WA_NUMBER}?text=${text}`, '_blank')
}

loadMenus()
</script>

</body>
</html>
